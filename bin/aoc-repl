#!/usr/bin/env bash

##
## start a REPL
##

usage() {
    local exitcode=${1:-1}

    langs=()
    # shellcheck disable=SC2312
    while IFS= read -r -d '' filename; do
        langs+=("$(basename "$(dirname "${filename}")")")
    done < <(find lang -type f -name 'Dockerfile' -print0 | sort -z)

    echo "usage: aoc-repl -l <language> [ -y <year> ] [ -t <tag> ]"
    echo "       aoc-repl [ -y <year> ] [ -t <tag> ] <language>"
    echo ""
    echo "Starts a REPL in a Docker container for the language, with data files mounted."
    echo ""
    echo "Options:"
    echo "* -l -- language"
    echo "* -y -- year (defaults to current year) ('none' is also permitted)"
    echo "* -t -- tag for language Docker image (defaults to 'latest')"
    echo ""
    echo "<language> must be one of: " "${langs[@]}"

    exit "${exitcode}"
}

while getopts ":hl:t:y:" opt; do
    case ${opt} in
        h) # help
            usage 0
            ;;

        l) # lang
            AOC_LANG=${OPTARG}
            ;;

        t) # tag for lang image
            AOC_TAG=${OPTARG}
            ;;

        y) # year
            AOC_YEAR=${OPTARG}
            ;;

        \?)
            echo "invalid option -${OPTARG}" 1>&2
            usage
            ;;

        :)
            echo "option ${OPTARG} requires an argument" 1>&2
            usage
            ;;

        *) ;;
    esac
done
shift $((OPTIND - 1))

# for Linux? CURRENT_YEAR=$(date --iso-8601 | cut -d '-' -f 1)
# shellcheck disable=SC2312
CURRENT_YEAR=$(date -I | cut -d '-' -f 1)

export AOC_LANG=${AOC_LANG:-$1}
export AOC_TAG=${AOC_TAG:-latest}
export AOC_YEAR=${AOC_YEAR:-${CURRENT_YEAR}}

if [[ -z "${AOC_LANG}" ]]; then
    usage
elif [[ ! -d "lang/${AOC_LANG}" ]]; then
    echo "unknown language ${AOC_LANG}"
    usage
fi

if [[ -x "lang/${AOC_LANG}/aoc-repl" ]]; then
    "lang/${AOC_LANG}/aoc-repl" -y "${AOC_YEAR}" -t "${AOC_TAG}"
else
    if [[ -z "${AOC_YEAR}" ]]; then
        usage
    elif [[ "${AOC_YEAR}" == "none" ]]; then
        echo "starting REPL without data files"
        unset AOC_YEAR
    elif ((AOC_YEAR < 2015 || AOC_YEAR > CURRENT_YEAR)); then
        echo "year out of range"
        usage
    fi

    # shellcheck source=/dev/null
    [[ -r "lang/${AOC_LANG}/.aocrc" ]] && source "lang/${AOC_LANG}/.aocrc"

    CONTAINER_NAME="aoc-${AOC_LANG}${AOC_YEAR:+-${AOC_YEAR}}"
    STATE=

    # shellcheck disable=SC2312
    if [[ "$(docker ps --all --format json | jq -r '.Names')" == "${CONTAINER_NAME}" ]]; then
        case $(docker ps --all --format json | jq -r --arg name "${CONTAINER_NAME}" 'select(.Names == $name) | .State') in
            running)
                # echo "container is already running"
                STATE="running"
                ;;

            exited)
                docker rm "${CONTAINER_NAME}"
                ;;

            *) ;;
        esac
    fi

    # shellcheck disable=SC2086
    if [[ "${STATE}" == "running" ]]; then
        docker exec \
            --env AOC_LANG \
            --env AOC_TAG \
            --env AOC_YEAR \
            --interactive \
            --tty \
            ${ADDITIONAL_FLAGS:-} \
            "${CONTAINER_NAME}" "bin/repl"
    else
        docker run \
            --env AOC_LANG \
            --env AOC_TAG \
            --env AOC_YEAR \
            --interactive \
            ${AOC_YEAR:+--mount "type=bind,src=./years/${AOC_YEAR}/${AOC_LANG},dst=/aoc/src"} \
            ${AOC_YEAR:+--mount "type=bind,src=./years/${AOC_YEAR}/data,dst=/aoc/data"} \
            ${ADDITIONAL_MOUNTS:-} \
            --name "${CONTAINER_NAME}" \
            --rm \
            --tty \
            ${ADDITIONAL_FLAGS:-} \
            "ghcr.io/krisalyssa/aoc/aoc-${AOC_LANG}:${AOC_TAG}" \
            -c "bin/repl"
    fi
fi
