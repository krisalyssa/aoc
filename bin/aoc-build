#!/usr/bin/env bash

##
## build an image for a language for local testing
##

AOC_ROOT="$(dirname "$0")/.."

usage() {
    local exitcode=${1:-1}

    langs=()
    # shellcheck disable=SC2312
    while IFS= read -r -d '' filename; do
        langs+=("$(basename "$(dirname "${filename}")")")
    done < <(find "${AOC_ROOT}/lang" -type f -name 'Dockerfile' -print0 | sort -z)

    echo "usage: aoc-build -l <language> [ -t <tag> ]"
    echo "       aoc-build [ -t <tag> ] <language>"
    echo ""
    echo "Builds a Docker image for the language."
    echo ""
    echo "Options:"
    echo "* -l -- language"
    echo "* -t -- tag for language Docker image (defaults to 'local')"
    echo ""
    echo "<language> must be one of: " "${langs[@]}"

    exit "${exitcode}"
}

while getopts ":hl:t:" opt; do
    case ${opt} in
        h) # help
            usage 0
            ;;

        l) # lang
            AOC_LANG=${OPTARG}
            ;;

        t) # tag for lang image
            AOC_TAG=${OPTARG}
            ;;

        \?)
            echo "invalid option -${OPTARG}" 1>&2
            usage
            ;;

        :)
            echo "option ${OPTARG} requires an argument" 1>&2
            usage
            ;;

        *) ;;
    esac
done
shift $((OPTIND - 1))

AOC_LANG=${AOC_LANG:-$1}
AOC_TAG=${AOC_TAG:-local}

[[ -z "${AOC_LANG}" ]] && usage

if [[ -d "${AOC_ROOT}/lang/${AOC_LANG}" ]]; then
    if [[ -x "${AOC_ROOT}/lang/${AOC_LANG}/aoc-build" ]]; then
        "${AOC_ROOT}/lang/${AOC_LANG}/aoc-build" "$@"
    elif [[ ! -r "${AOC_ROOT}/lang/${AOC_LANG}/Dockerfile" ]]; then
        echo "no Dockerfile for language ${AOC_LANG}"
        exit 1
    else
        # shellcheck source=/dev/null
        if [[ -r "${AOC_ROOT}/lang/${AOC_LANG}/.aocrc" ]]; then
            source "${AOC_ROOT}/lang/${AOC_LANG}/.aocrc"
        fi

        # shellcheck disable=SC2086
        docker build \
            --file "${AOC_ROOT}/lang/${AOC_LANG}/Dockerfile" \
            --tag "ghcr.io/krisalyssa/aoc/aoc-${AOC_LANG}:${AOC_TAG}" \
            ${ADDITIONAL_FLAGS:-} \
            "${AOC_ROOT}/lang/${AOC_LANG}"
    fi
else
    echo "unknown language '${AOC_LANG}'"
    exit 1
fi
