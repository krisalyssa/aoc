#!/usr/bin/env bash

usage() {
  echo "usage: aoc-run [-d day] [-y year] <language>"
  exit 1
}

CURRENT_YEAR=$( date --iso-8601 | cut -d '-' -f 1 )
CURRENT_DAY=$( date --iso-8601 | cut -d '-' -f 3 )

YEAR=${CURRENT_YEAR}
DAY=${CURRENT_DAY}

while getopts ":d:y:" opt; do
  case ${opt} in
    d ) # day
      DAY=${OPTARG}
      ;;

    y ) # year
      YEAR=${OPTARG}
      ;;

    h )
      echo "invalid option -${opt}" 1>&2
      usage
      ;;

    : )
      echo "option ${opt} requires an argument" 1>&2
      usage
      ;;
  esac
done
shift $(( OPTIND - 1 ))

# strip leading zero, if any
DAY=$(( DAY + 0 ))

if (( YEAR < 2015 || YEAR > CURRENT_YEAR )); then
  echo "year out of range"
  usage
fi

if (( DAY < 1 || DAY > 25 )); then
  echo "day out of range"
  usage
fi

if (( YEAR == CURRENT_YEAR && DAY > CURRENT_DAY )); then
  echo "day ${DAY} hasn't been released yet"
  usage
fi

AOC_LANG=$1

if [[ -d "lang/${AOC_LANG}" ]]; then
  if [[ -x "lang/${AOC_LANG}/bin/run" ]]; then
    shift
    echo "running ${AOC_LANG} for ${YEAR} day ${DAY}"
    echo ""
    lang/${AOC_LANG}/bin/run ${YEAR} ${DAY}
  else
    echo "no run script for ${AOC_LANG}"
    exit 1
  fi
else
  echo "unknown language ${AOC_LANG}"
  exit 1
fi